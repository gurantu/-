<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚¤ãƒˆãƒ¬è¨˜éŒ²ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .upload-section input[type="file"] { display: none; }
        .upload-btn {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
        }
        .upload-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        .trade-list { margin-top: 30px; }
        .trade-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-left: 5px solid #ccc;
        }
        .trade-item.profit {
            border-left-color: #e74c3c;
            background: #ffe6e6;
        }
        .trade-item.loss {
            border-left-color: #3498db;
            background: #e6f2ff;
        }
        .trade-item.zero {
            border-left-color: #95a5a6;
            background: #f8f9fa;
        }
        .trade-info { flex: 1; }
        .trade-date {
            font-size: 0.9em;
            color: #666;
        }
        .trade-name {
            font-size: 1.2em;
            font-weight: bold;
            margin: 5px 0;
        }
        .trade-detail {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .trade-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
        }
        .trade-amount {
            font-size: 1.5em;
            font-weight: bold;
            text-align: right;
        }
        .trade-amount.profit { color: #e74c3c; }
        .trade-amount.loss { color: #3498db; }
        .trade-amount.zero { color: #95a5a6; }
        .test-profit-section {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .test-profit-input {
            width: 120px;
            padding: 5px;
            border: 2px solid #f39c12;
            border-radius: 5px;
            font-size: 1em;
        }
        .copy-profit-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 5px;
        }
        .copy-profit-btn:hover { background: #e67e22; }
        select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        .post-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-section label {
            font-weight: bold;
            color: #667eea;
        }
        .stats-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stats-tab {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .stats-tab:hover {
            background: #f0f0f0;
        }
        .stats-tab.active {
            background: #667eea;
            color: white;
        }
        .method-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .method-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ãƒ‡ã‚¤ãƒˆãƒ¬è¨˜éŒ²ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        
        <div class="upload-section">
            <p style="margin-bottom: 15px; color: #666;">
                ğŸ“ è¨¼åˆ¸ä¼šç¤¾ã®ç´„å®šå±¥æ­´CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„<br>
                <small>å¿…è¦ãªåˆ—: æ—¥ä»˜ã€éŠ˜æŸ„åã€æç›Š</small>
            </p>
            <input type="file" id="csvFile" accept=".csv">
            <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                ğŸ“‚ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </button>
        </div>

        <div class="filter-section">
            <label>ğŸ“… æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿:</label>
            <select id="periodFilter" onchange="applyFilter()">
                <option value="all">å…¨æœŸé–“</option>
                <option value="thisMonth">ä»Šæœˆ</option>
                <option value="thisWeek">ä»Šé€±</option>
            </select>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>ç·æç›Š</h3>
                <div class="value" id="totalProfit">Â¥0</div>
            </div>
            <div class="stat-card">
                <h3>ãƒˆãƒ¬ãƒ¼ãƒ‰å›æ•°</h3>
                <div class="value" id="tradeCount">0</div>
            </div>
            <div class="stat-card">
                <h3>å‹ç‡</h3>
                <div class="value" id="winRate">0%</div>
            </div>
            <div class="stat-card">
                <h3>å¹³å‡æç›Š</h3>
                <div class="value" id="avgProfit">Â¥0</div>
            </div>
        </div>

        <div class="stats-tabs">
            <button class="stats-tab active" onclick="switchStatsTab('real-method')">å®Ÿãƒˆãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•åˆ¥</button>
            <button class="stats-tab" onclick="switchStatsTab('real-special')">å®Ÿãƒˆãƒ¬ãƒ¼ãƒ‰ç‰¹æ®Šçµ±è¨ˆ</button>
            <button class="stats-tab" onclick="switchStatsTab('test-method')">æ¤œè¨¼æ‰‹æ³•åˆ¥</button>
            <button class="stats-tab" onclick="switchStatsTab('test-special')">æ¤œè¨¼ç‰¹æ®Šçµ±è¨ˆ</button>
        </div>

        <div id="methodStats" class="method-stats" style="display: none;">
            <h2 style="margin-bottom: 15px; color: #667eea;">æ‰‹æ³•åˆ¥çµ±è¨ˆ</h2>
            <div id="methodStatsContent"></div>
        </div>

        <div class="trade-list" id="tradeList"></div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showMethodStats()">ğŸ“Š æ‰‹æ³•åˆ¥çµ±è¨ˆã‚’è¡¨ç¤º</button>
            <button class="btn btn-success" onclick="generatePost()">ğŸ“± XæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="downloadJSON()">ğŸ’¾ JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>

        <div id="postPreview"></div>
    </div>

    <script>
        const STORAGE_KEY = 'daytradeRecords';
        const methods = ['æŠ¼ã—ç›®', 'é€†å¼µã‚Š', 'ãƒ–ãƒ¬ã‚¤ã‚¯', 'ãã®ä»–'];
        let savedTrades = [];
        let currentPeriodFilter = 'all';
        let currentStatsTab = 'real-method';

        document.getElementById('csvFile').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ã¾ãšShift_JISã§è©¦ã™
            const reader = new FileReader();
            reader.onload = function(e) {
                let text = e.target.result;
                
                // Shift_JISã§èª­ã‚ãŸã‹ç¢ºèªï¼ˆæ–‡å­—åŒ–ã‘ãƒã‚§ãƒƒã‚¯ï¼‰
                if (text.includes('ï¿½') || !text.includes('ç´„å®šæ—¥')) {
                    // Shift_JISã§å¤±æ•—ã—ãŸå ´åˆã€UTF-8ã§å†è©¦è¡Œ
                    const utf8Reader = new FileReader();
                    utf8Reader.onload = function(e2) {
                        processCSV(e2.target.result);
                    };
                    utf8Reader.onerror = function() {
                        alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    };
                    utf8Reader.readAsText(file, 'UTF-8');
                } else {
                    processCSV(text);
                }
            };
            reader.onerror = function() {
                // Shift_JISã§å¤±æ•—ã—ãŸå ´åˆã€UTF-8ã§è©¦ã™
                const utf8Reader = new FileReader();
                utf8Reader.onload = function(e) {
                    processCSV(e.target.result);
                };
                utf8Reader.onerror = function() {
                    alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                };
                utf8Reader.readAsText(file, 'UTF-8');
            };
            reader.readAsText(file, 'Shift_JIS');
        }

        function processCSV(text) {
            const lines = text.split('\n');
            const rawTrades = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™
            let dataStartIndex = 0;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('ç´„å®šæ—¥') && lines[i].includes('éŠ˜æŸ„')) {
                    dataStartIndex = i + 1;
                    break;
                }
            }
            
            if (dataStartIndex === 0) {
                alert('âŒ ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nCSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã€Œç´„å®šæ—¥ã€ã¨ã€ŒéŠ˜æŸ„ã€åˆ—ãŒå¿…è¦ã§ã™');
                return;
            }
            
            // å…¨ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
            for (let i = dataStartIndex; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const cols = lines[i].split(',');
                if (cols.length < 14) continue;
                
                const date = cols[0].replace(/"/g, '').trim();
                const name = cols[1].replace(/"/g, '').trim();
                const code = cols[2].replace(/"/g, '').trim();
                const type = cols[4].replace(/"/g, '').trim(); // å–å¼•ç¨®é¡ï¼ˆè²·/å£²ï¼‰
                const qty = parseInt(cols[8].replace(/"/g, '').trim());
                const prc = parseFloat(cols[9].replace(/"/g, '').trim());
                const amt = parseInt(cols[13].replace(/"/g, '').trim()); // å—æ¸¡é‡‘é¡
                
                if (!date || !name || !code || !type || isNaN(qty) || isNaN(prc) || isNaN(amt)) continue;
                
                rawTrades.push({date, name, code, type, quantity: qty, price: prc, amount: amt});
            }
            
            if (rawTrades.length === 0) {
                alert('âŒ ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }
            
            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const tradesByDate = {};
            rawTrades.forEach(trade => {
                if (!tradesByDate[trade.date]) tradesByDate[trade.date] = [];
                tradesByDate[trade.date].push(trade);
            });
            
            // è²·ã„ã¨å£²ã‚Šã‚’ãƒšã‚¢ãƒªãƒ³ã‚°
            const newTrades = [];
            Object.entries(tradesByDate).forEach(([date, dayTrades]) => {
                const buys = dayTrades.filter(t => t.type.includes('è²·'));
                const sells = dayTrades.filter(t => t.type.includes('å£²'));
                
                // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const stockMap = {};
                buys.forEach(buy => {
                    if (!stockMap[buy.code]) stockMap[buy.code] = {buys: [], sells: []};
                    stockMap[buy.code].buys.push(buy);
                });
                sells.forEach(sell => {
                    if (!stockMap[sell.code]) stockMap[sell.code] = {buys: [], sells: []};
                    stockMap[sell.code].sells.push(sell);
                });
                
                // ãƒšã‚¢ãƒªãƒ³ã‚°
                Object.entries(stockMap).forEach(([code, data]) => {
                    const pairCount = Math.min(data.buys.length, data.sells.length);
                    for (let i = 0; i < pairCount; i++) {
                        const buy = data.buys[i];
                        const sell = data.sells[i];
                        const profit = Math.round(sell.amount - buy.amount);
                        
                        newTrades.push({
                            date: date,
                            name: buy.name,
                            profit: profit,
                            method: null,
                            hasLowerWick: false,
                            testProfit: null
                        });
                    }
                });
            });
            
            if (newTrades.length === 0) {
                alert('âŒ å£²è²·ãƒšã‚¢ãŒæˆç«‹ã—ã¾ã›ã‚“ã§ã—ãŸ\nåŒã˜æ—¥ã«è²·ã„ã¨å£²ã‚ŠãŒå¿…è¦ã§ã™');
                return;
            }
            
            savedTrades.push(...newTrades);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedTrades));
            displayTrades();
            alert(`âœ… ${newTrades.length}ä»¶ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        function loadSavedTrades() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                savedTrades = JSON.parse(saved);
                displayTrades();
            }
        }

        function getFilteredTrades() {
            if (currentPeriodFilter === 'all') return savedTrades;
            
            const now = new Date();
            return savedTrades.filter(trade => {
                const tradeDate = new Date(trade.date);
                if (currentPeriodFilter === 'thisMonth') {
                    return tradeDate.getMonth() === now.getMonth() && 
                           tradeDate.getFullYear() === now.getFullYear();
                } else if (currentPeriodFilter === 'thisWeek') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return tradeDate >= weekAgo;
                }
                return true;
            });
        }

        function applyFilter() {
            currentPeriodFilter = document.getElementById('periodFilter').value;
            displayTrades();
            if (document.getElementById('methodStats').style.display === 'block') {
                showMethodStats();
            }
        }

        function displayTrades() {
            const filteredTrades = getFilteredTrades();
            const list = document.getElementById('tradeList');
            list.innerHTML = '';
            
            // é‡è¤‡æ¤œå‡ºï¼ˆåŒæ—¥ãƒ»åŒéŠ˜æŸ„ã®å®Œæˆãƒˆãƒ¬ãƒ¼ãƒ‰æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼‰
            // é‡è¦: CSVã®è¡Œæ•°ã§ã¯ãªãã€ãƒšã‚¢ãƒªãƒ³ã‚°å¾Œã®ãƒˆãƒ¬ãƒ¼ãƒ‰æ•°ã§åˆ¤å®š
            const duplicateMap = {};
            savedTrades.forEach(trade => {
                const key = `${trade.date}_${trade.name}`;
                duplicateMap[key] = (duplicateMap[key] || 0) + 1;
            });
            
            let totalProfit = 0;
            let wins = 0;
            
            filteredTrades.forEach((trade, index) => {
                // å®Ÿéš›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã§ã¯ãªãå…ƒã®é…åˆ—ã§ã®ä½ç½®ï¼‰
                const actualIndex = savedTrades.indexOf(trade);
                
                // ä¿®æ­£ã•ã‚ŒãŸæç›Šã‚’ä½¿ç”¨ï¼ˆãªã‘ã‚Œã°å…ƒã®æç›Šï¼‰
                const actualProfit = trade.correctedProfit !== undefined ? trade.correctedProfit : trade.profit;
                totalProfit += actualProfit;
                if (actualProfit > 0) wins++;
                
                const div = document.createElement('div');
                const profitClass = actualProfit > 0 ? 'profit' : actualProfit < 0 ? 'loss' : 'zero';
                div.className = `trade-item ${profitClass}`;
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšã‚¢ãƒªãƒ³ã‚°å¾Œã®ãƒˆãƒ¬ãƒ¼ãƒ‰ãŒ2å›ä»¥ä¸Š = çœŸã®é‡è¤‡ï¼‰
                const key = `${trade.date}_${trade.name}`;
                const isDuplicate = duplicateMap[key] >= 2;
                
                const methodSelect = `
                    <select onchange="updateMethod(${actualIndex}, this.value)">
                        <option value="">æ‰‹æ³•ã‚’é¸æŠ</option>
                        ${methods.map(m => `<option value="${m}" ${trade.method === m ? 'selected' : ''}>${m}</option>`).join('')}
                    </select>
                `;
                
                // é‡è¤‡æ™‚ã®ã¿å®Ÿåæ”¯ä¿®æ­£æ¬„ã‚’è¡¨ç¤º
                const duplicateWarning = isDuplicate ? '<div style="color: #e67e22; font-weight: bold; margin-top: 5px;">âš ï¸ åŒä¸€éŠ˜æŸ„2å›ä»¥ä¸Šæ¤œå‡º</div>' : '';
                const realProfitInput = isDuplicate ? `
                    <div style="background: #ffe6cc; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <label style="font-size: 0.9em; display: block; margin-bottom: 5px;">å®Ÿåæ”¯ã‚’ä¿®æ­£(æ­£ã—ã‘ã‚Œã°ãã®ã¾ã¾)</label>
                        <input type="number" class="test-profit-input" id="realProfit${actualIndex}" 
                               value="${actualProfit}" 
                               onchange="updateRealProfit(${actualIndex}, this.value)">
                    </div>
                ` : '';
                
                const testProfitSection = `
                    <div class="test-profit-section">
                        <label style="font-size: 0.9em; color: #856404;">æ¤œè¨¼æç›Š:</label>
                        <input type="number" class="test-profit-input" value="${trade.testProfit || ''}" 
                               onchange="updateTestProfit(${actualIndex}, this.value)" placeholder="å††">
                        <button class="copy-profit-btn" onclick="copyProfit(${actualIndex})">å®Ÿæç›Šã‚³ãƒ”ãƒ¼</button>
                    </div>
                `;
                
                div.innerHTML = `
                    <div class="trade-info">
                        <div class="trade-date">${trade.date}</div>
                        <div class="trade-name">${trade.name}</div>
                        <div class="trade-detail">æ‰‹æ³•: ${trade.method || 'æœªè¨­å®š'}</div>
                        ${duplicateWarning}
                    </div>
                    <div class="trade-controls">
                        <div class="trade-amount ${profitClass}">
                            ${isDuplicate ? 'è‡ªå‹•è¨ˆç®—: ' : ''}${actualProfit > 0 ? '+' : ''}${actualProfit.toLocaleString()}å††
                        </div>
                        ${methodSelect}
                        <label class="checkbox-label">
                            <input type="checkbox" ${trade.hasLowerWick ? 'checked' : ''} 
                                   onchange="updateWick(${actualIndex}, this.checked)">
                            <span>ä¸‹ãƒ’ã‚²ã‚ã‚Š</span>
                        </label>
                        ${realProfitInput}
                        ${testProfitSection}
                    </div>
                `;
                list.appendChild(div);
            });
            
            const winRate = filteredTrades.length > 0 ? (wins / filteredTrades.length * 100).toFixed(1) : 0;
            const avgProfit = filteredTrades.length > 0 ? Math.round(totalProfit / filteredTrades.length) : 0;
            
            document.getElementById('totalProfit').textContent = `Â¥${totalProfit.toLocaleString()}`;
            document.getElementById('tradeCount').textContent = filteredTrades.length;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('avgProfit').textContent = `Â¥${avgProfit.toLocaleString()}`;
        }

        function updateMethod(index, method) {
            savedTrades[index].method = method || null;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedTrades));
            displayTrades();
        }

        function updateWick(index, hasWick) {
            savedTrades[index].hasLowerWick = hasWick;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedTrades));
        }

        function updateRealProfit(index, value) {
            savedTrades[index].correctedProfit = value ? parseInt(value) : undefined;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedTrades));
            displayTrades();
        }

        function updateTestProfit(index, value) {
            savedTrades[index].testProfit = value ? parseInt(value) : null;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedTrades));
        }

        function copyProfit(index) {
            const actualProfit = savedTrades[index].correctedProfit !== undefined ? 
                                savedTrades[index].correctedProfit : 
                                savedTrades[index].profit;
            savedTrades[index].testProfit = actualProfit;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedTrades));
            displayTrades();
        }

        function switchStatsTab(tab) {
            currentStatsTab = tab;
            document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (document.getElementById('methodStats').style.display === 'block') {
                showMethodStats();
            }
        }

        function showMethodStats() {
            const filteredTrades = getFilteredTrades();
            const content = document.getElementById('methodStatsContent');
            content.innerHTML = '';
            
            if (currentStatsTab === 'real-method') {
                const methodMap = {};
                filteredTrades.forEach(trade => {
                    if (!trade.method) return;
                    if (!methodMap[trade.method]) methodMap[trade.method] = {count: 0, profit: 0, wins: 0};
                    const actualProfit = trade.correctedProfit !== undefined ? trade.correctedProfit : trade.profit;
                    methodMap[trade.method].count++;
                    methodMap[trade.method].profit += actualProfit;
                    if (actualProfit > 0) methodMap[trade.method].wins++;
                });
                
                let totalCount = 0, totalProfit = 0, totalWins = 0;
                Object.entries(methodMap).sort((a, b) => b[1].profit - a[1].profit).forEach(([method, data]) => {
                    const winRate = ((data.wins / data.count) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.innerHTML = `
                        <div><strong>${method}</strong> (${data.count}å› | å‹ç‡${winRate}%)</div>
                        <div style="font-weight: bold; color: ${data.profit > 0 ? '#e74c3c' : '#3498db'}">${data.profit > 0 ? '+' : ''}${data.profit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                    totalCount += data.count; totalProfit += data.profit; totalWins += data.wins;
                });
                
                if (totalCount > 0) {
                    const totalWinRate = ((totalWins / totalCount) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.style.borderTop = '3px solid #667eea';
                    div.style.marginTop = '10px';
                    div.style.paddingTop = '15px';
                    div.style.background = '#f0f0f0';
                    div.innerHTML = `
                        <div><strong>ğŸ“Š åˆè¨ˆ</strong> (${totalCount}å› | å‹ç‡${totalWinRate}%)</div>
                        <div style="font-weight: bold; font-size: 1.2em; color: ${totalProfit > 0 ? '#e74c3c' : '#3498db'}">${totalProfit > 0 ? '+' : ''}${totalProfit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                }
            } else if (currentStatsTab === 'real-special') {
                const wickStats = {withWick: {count: 0, profit: 0, wins: 0}, withoutWick: {count: 0, profit: 0, wins: 0}};
                filteredTrades.forEach(trade => {
                    const actualProfit = trade.correctedProfit !== undefined ? trade.correctedProfit : trade.profit;
                    const key = trade.hasLowerWick ? 'withWick' : 'withoutWick';
                    wickStats[key].count++; 
                    wickStats[key].profit += actualProfit;
                    if (actualProfit > 0) wickStats[key].wins++;
                });
                
                let totalCount = 0, totalProfit = 0, totalWins = 0;
                [['ä¸‹ãƒ’ã‚²ã‚ã‚Š', wickStats.withWick], ['ä¸‹ãƒ’ã‚²ãªã—', wickStats.withoutWick]].forEach(([label, data]) => {
                    if (data.count === 0) return;
                    const winRate = ((data.wins / data.count) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.innerHTML = `
                        <div><strong>${label}</strong> (${data.count}å› | å‹ç‡${winRate}%)</div>
                        <div style="font-weight: bold; color: ${data.profit > 0 ? '#e74c3c' : '#3498db'}">${data.profit > 0 ? '+' : ''}${data.profit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                    totalCount += data.count; totalProfit += data.profit; totalWins += data.wins;
                });
                
                if (totalCount > 0) {
                    const totalWinRate = ((totalWins / totalCount) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.style.borderTop = '3px solid #667eea';
                    div.style.marginTop = '10px';
                    div.style.paddingTop = '15px';
                    div.style.background = '#f0f0f0';
                    div.innerHTML = `
                        <div><strong>ğŸ“Š åˆè¨ˆ</strong> (${totalCount}å› | å‹ç‡${totalWinRate}%)</div>
                        <div style="font-weight: bold; font-size: 1.2em; color: ${totalProfit > 0 ? '#e74c3c' : '#3498db'}">${totalProfit > 0 ? '+' : ''}${totalProfit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                }
            } else if (currentStatsTab === 'test-method') {
                const methodMap = {};
                filteredTrades.filter(t => t.testProfit !== null).forEach(trade => {
                    if (!trade.method) return;
                    if (!methodMap[trade.method]) methodMap[trade.method] = {count: 0, profit: 0, wins: 0};
                    methodMap[trade.method].count++;
                    methodMap[trade.method].profit += trade.testProfit;
                    if (trade.testProfit > 0) methodMap[trade.method].wins++;
                });
                
                let totalCount = 0, totalProfit = 0, totalWins = 0;
                Object.entries(methodMap).sort((a, b) => b[1].profit - a[1].profit).forEach(([method, data]) => {
                    const winRate = ((data.wins / data.count) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.innerHTML = `
                        <div><strong>${method}</strong> (${data.count}å› | å‹ç‡${winRate}%)</div>
                        <div style="font-weight: bold; color: ${data.profit > 0 ? '#e74c3c' : '#3498db'}">${data.profit > 0 ? '+' : ''}${data.profit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                    totalCount += data.count; totalProfit += data.profit; totalWins += data.wins;
                });
                
                if (totalCount > 0) {
                    const totalWinRate = ((totalWins / totalCount) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.style.borderTop = '3px solid #667eea';
                    div.style.marginTop = '10px';
                    div.style.paddingTop = '15px';
                    div.style.background = '#f0f0f0';
                    div.innerHTML = `
                        <div><strong>ğŸ“Š åˆè¨ˆ</strong> (${totalCount}å› | å‹ç‡${totalWinRate}%)</div>
                        <div style="font-weight: bold; font-size: 1.2em; color: ${totalProfit > 0 ? '#e74c3c' : '#3498db'}">${totalProfit > 0 ? '+' : ''}${totalProfit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                }
            } else if (currentStatsTab === 'test-special') {
                const wickStats = {withWick: {count: 0, profit: 0, wins: 0}, withoutWick: {count: 0, profit: 0, wins: 0}};
                filteredTrades.filter(t => t.testProfit !== null).forEach(trade => {
                    const key = trade.hasLowerWick ? 'withWick' : 'withoutWick';
                    wickStats[key].count++; wickStats[key].profit += trade.testProfit;
                    if (trade.testProfit > 0) wickStats[key].wins++;
                });
                
                let totalCount = 0, totalProfit = 0, totalWins = 0;
                [['ä¸‹ãƒ’ã‚²ã‚ã‚Š', wickStats.withWick], ['ä¸‹ãƒ’ã‚²ãªã—', wickStats.withoutWick]].forEach(([label, data]) => {
                    if (data.count === 0) return;
                    const winRate = ((data.wins / data.count) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.innerHTML = `
                        <div><strong>${label}</strong> (${data.count}å› | å‹ç‡${winRate}%)</div>
                        <div style="font-weight: bold; color: ${data.profit > 0 ? '#e74c3c' : '#3498db'}">${data.profit > 0 ? '+' : ''}${data.profit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                    totalCount += data.count; totalProfit += data.profit; totalWins += data.wins;
                });
                
                if (totalCount > 0) {
                    const totalWinRate = ((totalWins / totalCount) * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.style.borderTop = '3px solid #667eea';
                    div.style.marginTop = '10px';
                    div.style.paddingTop = '15px';
                    div.style.background = '#f0f0f0';
                    div.innerHTML = `
                        <div><strong>ğŸ“Š åˆè¨ˆ</strong> (${totalCount}å› | å‹ç‡${totalWinRate}%)</div>
                        <div style="font-weight: bold; font-size: 1.2em; color: ${totalProfit > 0 ? '#e74c3c' : '#3498db'}">${totalProfit > 0 ? '+' : ''}${totalProfit.toLocaleString()}å††</div>
                    `;
                    content.appendChild(div);
                }
            }
            document.getElementById('methodStats').style.display = 'block';
        }

        function generatePost() {
            const dateMap = {};
            savedTrades.forEach(trade => {
                if (!dateMap[trade.date]) dateMap[trade.date] = [];
                dateMap[trade.date].push(trade);
            });
            let postText = 'ã€ä»Šé€±ã®ãƒˆãƒ¬ãƒ¼ãƒ‰çµæœã€‘\n\n';
            Object.entries(dateMap).forEach(([date, dayTrades]) => {
                const dayProfit = dayTrades.reduce((sum, t) => {
                    const actualProfit = t.correctedProfit !== undefined ? t.correctedProfit : t.profit;
                    return sum + actualProfit;
                }, 0);
                postText += `${date}\n`;
                dayTrades.forEach(trade => {
                    const actualProfit = trade.correctedProfit !== undefined ? trade.correctedProfit : trade.profit;
                    const sign = actualProfit > 0 ? '+' : '';
                    postText += `ãƒ»${trade.name}(${trade.method || 'æœªè¨­å®š'}) ${sign}${actualProfit.toLocaleString()}å††\n`;
                });
                const daySign = dayProfit > 0 ? '+' : '';
                postText += `â†’ æ—¥æ¬¡: ${daySign}${dayProfit.toLocaleString()}å††\n\n`;
            });
            const totalProfit = savedTrades.reduce((sum, t) => {
                const actualProfit = t.correctedProfit !== undefined ? t.correctedProfit : t.profit;
                return sum + actualProfit;
            }, 0);
            const winDays = Object.values(dateMap).filter(trades => {
                const dayProfit = trades.reduce((sum, t) => {
                    const actualProfit = t.correctedProfit !== undefined ? t.correctedProfit : t.profit;
                    return sum + actualProfit;
                }, 0);
                return dayProfit > 0;
            }).length;
            const totalDays = Object.keys(dateMap).length;
            postText += `ä»Šé€±åˆè¨ˆ: ${totalProfit > 0 ? '+' : ''}${totalProfit.toLocaleString()}å††\n`;
            postText += `å‹ç‡: ${winDays}/${totalDays}æ—¥ (${(winDays/totalDays*100).toFixed(1)}%)\n\n`;
            postText += '#ãƒ‡ã‚¤ãƒˆãƒ¬ #æ ªå¼æŠ•è³‡';
            const preview = document.getElementById('postPreview');
            preview.innerHTML = '<h2 style="margin-bottom: 15px;">ğŸ“± XæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ(ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)</h2>';
            const pre = document.createElement('div');
            pre.className = 'post-preview';
            pre.textContent = postText;
            preview.appendChild(pre);
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-primary';
            copyBtn.textContent = 'ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼';
            copyBtn.style.marginTop = '10px';
            copyBtn.onclick = function() {
                navigator.clipboard.writeText(postText);
                alert('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!');
            };
            preview.appendChild(copyBtn);
        }

        function downloadJSON() {
            const dataStr = JSON.stringify(savedTrades, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'daytrade_records.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function clearAllData() {
            if (confirm('âš ï¸ æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem(STORAGE_KEY);
                savedTrades = [];
                displayTrades();
                document.getElementById('postPreview').innerHTML = '';
                document.getElementById('methodStats').style.display = 'none';
                alert('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        loadSavedTrades();
    </script>
</body>
</html>
